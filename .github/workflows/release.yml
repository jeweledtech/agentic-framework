name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install package with dev deps
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Run tests
      env:
        USE_MOCK_KB: "true"
        ENABLE_AUTH: "false"
      run: |
        pytest tests/ -v --tb=short

  verify-version:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Verify tag matches package version
      env:
        TAG_REF: ${{ github.ref_name }}
      run: |
        TAG_VERSION="${TAG_REF#v}"
        PKG_VERSION=$(python -c "exec(open('core/_version.py').read()); print(__version__)")
        echo "Tag version:     $TAG_VERSION"
        echo "Package version: $PKG_VERSION"
        if [ "$TAG_VERSION" != "$PKG_VERSION" ]; then
          echo "ERROR: Tag version ($TAG_VERSION) does not match core/_version.py ($PKG_VERSION)"
          exit 1
        fi

  build:
    runs-on: ubuntu-latest
    needs: [test, verify-version]

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install build tools
      run: |
        python -m pip install --upgrade pip build

    - name: Build sdist and wheel
      run: |
        python -m build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist
        path: dist/

  release:
    runs-on: ubuntu-latest
    needs: build

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Generate changelog from git log
      run: |
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        if [ -z "$PREV_TAG" ]; then
          git log --pretty=format:"- %s" HEAD > /tmp/changes.txt
        else
          git log --pretty=format:"- %s" ${PREV_TAG}..HEAD > /tmp/changes.txt
        fi

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: dist
        path: dist/

    - name: Create GitHub Release
      env:
        TAG_NAME: ${{ github.ref_name }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release create "$TAG_NAME" dist/* \
          --title "Release $TAG_NAME" \
          --notes-file /tmp/changes.txt

  smoke-test:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/
      - name: Install wheel in clean environment
        run: |
          python -m venv /tmp/smoke-env
          /tmp/smoke-env/bin/pip install dist/*.whl
      - name: Smoke test - core imports and registry
        run: |
          /tmp/smoke-env/bin/python -c "
          from core._version import __version__
          from core.providers.llm import LLMRegistry, AnthropicProvider, OpenAIProvider, MockLLMProvider
          registry = LLMRegistry()
          mock = registry.get('mock')
          assert mock.provider_name == 'mock'
          result = mock.generate('test')
          assert len(result) > 0
          print(f'v{__version__} smoke test PASSED')
          "

  publish-pypi:
    runs-on: ubuntu-latest
    needs: [release, smoke-test]
    environment: pypi

    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: dist
        path: dist/

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_TOKEN }}
        skip-existing: true

  docker:
    runs-on: ubuntu-latest
    needs: [test, verify-version]

    steps:
    - uses: actions/checkout@v4

    - name: Build Docker images
      env:
        TAG_NAME: ${{ github.ref_name }}
      run: |
        docker build -f Dockerfile \
          -t "jeweledtech/agentic-framework:${TAG_NAME}" \
          -t jeweledtech/agentic-framework:latest \
          .

    - name: Push Docker images
      if: ${{ secrets.DOCKER_USERNAME != '' }}
      env:
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        TAG_NAME: ${{ github.ref_name }}
      run: |
        echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        docker push "jeweledtech/agentic-framework:${TAG_NAME}"
        docker push jeweledtech/agentic-framework:latest
